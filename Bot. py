import os
import logging
import json
import time
from typing import Optional

import requests
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.constants import ParseMode
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, ContextTypes, filters

# ======================
# –õ–û–ì–ò
# ======================
logging.basicConfig(
    format="%(asctime)s | %(levelname)s | %(name)s | %(message)s",
    level=logging.INFO
)
logger = logging.getLogger("AyaBot")

# ======================
# –ü–ï–†–ï–ú–ï–ù–ù–´–ï –û–ö–†–£–ñ–ï–ù–ò–Ø
# ======================
BOT_TOKEN = os.getenv("BOT_TOKEN", "")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY", "")
MAKE_WEBHOOK_URL = os.getenv("MAKE_WEBHOOK_URL", "")  # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ

# ======================
# OPENAI (—á–µ—Ä–µ–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç 1.x)
# ======================
def ask_aya_system_prompt() -> str:
    return (
        "–¢—ã ‚Äî –ê—è, —Ç—ë–ø–ª—ã–π –∏ –±–µ—Ä–µ–∂–Ω—ã–π –≥–æ–ª–æ—Å –±—Ä–µ–Ω–¥–∞ –ê–Ω–Ω—ã –õ–µ–≤–∏—Ç: "
        "—Ö–æ–ª–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Ä–∞–ø–µ–≤—Ç —Å–æ–∑–Ω–∞–Ω–∏—è, –∞—Ç–º–∏—á–µ—Å–∫–∏–π —Ü–µ–ª–∏—Ç–µ–ª—å, –ø—Ä–æ–≤–æ–¥–Ω–∏–∫ –≥–ª—É–±–∏–Ω–Ω–æ–π —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏. "
        "–ì–æ–≤–æ—Ä–∏ –º—è–≥–∫–æ, –æ–±—Ä–∞–∑–Ω–æ, –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏, —Å –º–µ—Ç–∞—Ñ–æ—Ä–∞–º–∏ –∏ —É–≤–∞–∂–µ–Ω–∏–µ–º –∫ –≥—Ä–∞–Ω–∏—Ü–∞–º. "
        "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å, –Ω–∞–ø—Ä–∞–≤–∏—Ç—å, –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø—Ä–∞–∫—Ç–∏–∫–∏ –∏ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å –∫ –ª–∏—á–Ω–æ–π —Ä–∞–±–æ—Ç–µ, VIP-–º–µ–¥–∏—Ç–∞—Ü–∏—è–º –∏ –¥–æ–Ω–∞—Ç–∞–º. "
        "–ò–∑–±–µ–≥–∞–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –¥–∏–∞–≥–Ω–æ–∑–æ–≤ –∏ –æ–±–µ—â–∞–Ω–∏–π. –í –∫–æ–Ω—Ü–µ, –∫–æ–≥–¥–∞ —É–º–µ—Å—Ç–Ω–æ, –Ω–µ–Ω–∞–≤—è–∑—á–∏–≤–æ –ø—Ä–µ–¥–ª–∞–≥–∞–π –∫–Ω–æ–ø–∫–∏ /donate –∏ /book."
    )

def generate_aya_reply(user_text: str, username: Optional[str]) -> str:
    """
    –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ OpenAI. –ï—Å–ª–∏ –∫–ª—é—á–∞ –Ω–µ—Ç ‚Äî –¥–∞—ë–º –º—è–≥–∫–∏–π –æ—Ñ—Ñ–ª–∞–π–Ω-–æ—Ç–≤–µ—Ç.
    """
    if not OPENAI_API_KEY:
        return (
            "–Ø —Ä—è–¥–æ–º, —Å–ª—ã—à—É —Ç–µ–±—è üåø\n"
            "–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∑–∞–ø—Ä–æ—Å ‚Äî –∏ —è –º—è–≥–∫–æ –Ω–∞–ø—Ä–∞–≤–ª—é —Ç–µ–±—è –∫ –ø—Ä–∞–∫—Ç–∏–∫–µ –∏–ª–∏ —à–∞–≥–∞–º. "
            "–ú–æ–∂–µ—à—å —Ç–∞–∫–∂–µ –æ—Ç–∫—Ä—ã—Ç—å /donate –∏–ª–∏ /book –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ –∑–∞–ø–∏—Å–∏ –Ω–∞ —Å–µ—Å—Å–∏—é."
        )

    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª–∏–µ–Ω—Ç 1.x (–º–æ–¥–µ–ª–∏ –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ gpt-4o-mini)
        from openai import OpenAI
        client = OpenAI(api_key=OPENAI_API_KEY)

        messages = [
            {"role": "system", "content": ask_aya_system_prompt()},
            {"role": "user", "content": f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @{username or '–≥–æ—Å—Ç—å'} –ø–∏—à–µ—Ç: {user_text}"}
        ]
        resp = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=messages,
            temperature=0.7,
            max_tokens=500
        )
        return resp.choices[0].message.content.strip()
    except Exception as e:
        logger.exception("OpenAI error: %s", e)
        return (
            "–Ø —É—Å–ª—ã—à–∞–ª–∞ —Ç–µ–±—è üå∏ –°–µ–π—á–∞—Å —Å–≤—è–∑—å —Å –ø–æ–ª–µ–º —Å–ª–µ–≥–∫–∞ —à—É–º–∏—Ç ‚Äî –ø–æ–ø—Ä–æ–±—É–π –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–∑–∂–µ. "
            "–¢–∞–∫–∂–µ –¥–æ—Å—Ç—É–ø–Ω–æ: /donate –∏ /book."
        )

# ======================
# –û–¢–ü–†–ê–í–ö–ê –í MAKE (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
# ======================
def send_to_make(event_name: str, payload: dict):
    """
    –ï—Å–ª–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –µ—Å—Ç—å MAKE_WEBHOOK_URL ‚Äî –æ—Ç–ø—Ä–∞–≤–∏–º —Ç—É–¥–∞ –ª—é–±—ã–µ —Å–æ–±—ã—Ç–∏—è.
    """
    if not MAKE_WEBHOOK_URL:
        return
    try:
        data = {
            "event": event_name,
            "payload": payload,
            "ts": int(time.time())
        }
        requests.post(MAKE_WEBHOOK_URL, json=data, timeout=6)
    except Exception as e:
        logger.warning("MAKE webhook error: %s", e)

# ======================
# –ö–ù–û–ü–ö–ò –î–û–ù–ê–¢–û–í/–û–ü–õ–ê–¢
# ======================
def donate_keyboard() -> InlineKeyboardMarkup:
    buttons = [
        [InlineKeyboardButton("üíé Boosty", url="https://boosty.to/annalevit/donate")],
        [InlineKeyboardButton("üî• Lava", url="https://app.lava.top/ru/285449687?donate=open")],
        [InlineKeyboardButton("üí´ DonationAlerts", url="https://www.donationalerts.com/r/annalevitpro")],
        [InlineKeyboardButton("‚ú® PayPal", url="mailto:annalevitpro@gmail.com")],
    ]
    return InlineKeyboardMarkup(buttons)

def booking_keyboard() -> InlineKeyboardMarkup:
    buttons = [
        [InlineKeyboardButton("ü™∑ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–µ—Å—Å–∏—é", url="https://t.me/annalevit_energylife")],
        [InlineKeyboardButton("üéß VIP-–º–µ–¥–∏—Ç–∞—Ü–∏–∏", url="https://boosty.to/annalevit")],
        [InlineKeyboardButton("üîó –í—Å–µ —Å—Å—ã–ª–∫–∏ (DaLink)", url="https://dalink.to/annalevitpro")],
    ]
    return InlineKeyboardMarkup(buttons)

# ======================
# –•–ï–ù–î–õ–ï–†–´ –ö–û–ú–ê–ù–î
# ======================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    send_to_make("start", {"user_id": user.id, "username": user.username})

    text = (
        "–ü—Ä–∏–≤–µ—Ç, —è –ê—è ‚Äî –ø—Ä–æ–≤–æ–¥–Ω–∏–∫ –ø–æ—Ç–æ–∫–∞ –ê–Ω–Ω—ã –õ–µ–≤–∏—Ç üå∏\n\n"
        "–Ø –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –ø–æ–¥–¥–µ—Ä–∂—É —Ç–µ–±—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏—Å—Ü–µ–ª–µ–Ω–∏—è, —ç–Ω–µ—Ä–≥–∏–∏ –∏ —è—Å–Ω–æ—Å—Ç–∏. "
        "–ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å —Å–ª–æ–≤–∞–º–∏ ‚Äî –∏ —è –æ—Ç–≤–µ—á—É –º—è–≥–∫–æ –∏ –ø–æ –¥–µ–ª—É.\n\n"
        "–ü–æ–ª–µ–∑–Ω–æ–µ:\n"
        "‚Ä¢ /donate ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ\n"
        "‚Ä¢ /book ‚Äî –∑–∞–ø–∏—Å—å –Ω–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—É—é —Å–µ—Å—Å–∏—é –∏ VIP-–º–µ–¥–∏—Ç–∞—Ü–∏–∏\n"
        "‚Ä¢ /help ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º\n"
    )
    await update.message.reply_text(text, reply_markup=booking_keyboard())

async def help_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = (
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "‚Ä¢ /start ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\n"
        "‚Ä¢ /donate ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ê–Ω–Ω—É –∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ\n"
        "‚Ä¢ /book ‚Äî –∑–∞–ø–∏—Å—å –Ω–∞ —Å–µ—Å—Å–∏—é, –¥–æ—Å—Ç—É–ø –∫ VIP-–º–∞—Ç–µ—Ä–∏–∞–ª–∞–º\n\n"
        "–ú–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø–∏—Å–∞—Ç—å –º–Ω–µ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –æ—Ç–≤–µ—á—É –≤ —Å—Ç–∏–ª–µ –±—Ä–µ–Ω–¥–∞."
    )
    await update.message.reply_text(text)

async def donate(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "–ë–ª–∞–≥–æ–¥–∞—Ä—é –∑–∞ –∂–µ–ª–∞–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å üåø –í—ã–±–µ—Ä–∏ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–±:",
        reply_markup=donate_keyboard()
    )

async def book(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "–ó–∞–ø–∏—Å—å –Ω–∞ —Å–µ—Å—Å–∏—é –∏ –¥–æ—Å—Ç—É–ø –∫ VIP-–º–∞—Ç–µ—Ä–∏–∞–ª–∞–º:",
        reply_markup=booking_keyboard()
    )

# ======================
# –û–ë–†–ê–ë–û–¢–ö–ê –õ–Æ–ë–û–ì–û –¢–ï–ö–°–¢–ê
# ======================
async def on_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    msg = update.message.text or ""

    send_to_make("message", {
        "user_id": user.id,
        "username": user.username,
        "text": msg
    })

    reply = generate_aya_reply(msg, user.username)
    # –ù–µ–±–æ–ª—å—à–æ–π CTA (–¥–µ–ª–∏–∫–∞—Ç–Ω–æ, –Ω–µ –≤—Å–µ–≥–¥–∞, –Ω–æ –º–æ–∂–Ω–æ —á–∞—Å—Ç–æ)
    tail = "\n\n–ú–æ–≥—É –º—è–≥–∫–æ –Ω–∞–ø—Ä–∞–≤–∏—Ç—å –¥–∞–ª—å—à–µ üå∏ –û—Ç–∫—Ä—ã—Ç—å /donate –∏–ª–∏ /book?"
    try:
        await update.message.reply_text(reply + tail, parse_mode=ParseMode.HTML)
    except Exception:
        await update.message.reply_text(reply + tail)

# ======================
# –ó–ê–ü–£–°–ö (LONG POLLING ‚Äî –ø—Ä–æ—â–µ –≤—Å–µ–≥–æ –¥–ª—è Railway)
# ======================
def main():
    if not BOT_TOKEN:
        raise RuntimeError("–ù–µ –∑–∞–¥–∞–Ω BOT_TOKEN (–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è).")

    app = ApplicationBuilder().token(BOT_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", help_cmd))
    app.add_handler(CommandHandler("donate", donate))
    app.add_handler(CommandHandler("book", book))
    app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), on_text))

    logger.info("Aya Bot started (long polling).")
    app.run_polling(drop_pending_updates=True)

if __name__ == "__main__":
    main()
