import os
import logging
import time
from typing import Optional

import requests
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.constants import ParseMode
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, ContextTypes, filters

# -------------------- –õ–û–ì–ò --------------------
logging.basicConfig(
    format="%(asctime)s | %(levelname)s | %(name)s | %(message)s",
    level=logging.INFO
)
logger = logging.getLogger("AyaBot")

# ---------------- –ü–ï–†–ï–ú–ï–ù–ù–´–ï –û–ö–†–£–ñ–ï–ù–ò–Ø ----------------
BOT_TOKEN = os.getenv("BOT_TOKEN", "")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY", "")
MAKE_WEBHOOK_URL = os.getenv("MAKE_WEBHOOK_URL", "")

GOOGLE_FORM_URL = os.getenv("GOOGLE_FORM_URL", "")
GOOGLE_FORM_PREFILL_TEMPLATE = os.getenv("GOOGLE_FORM_PREFILL_TEMPLATE", "")

# --------------- –°–ò–°–¢–ï–ú–ù–´–ô –ü–†–û–ú–ü–¢ –î–õ–Ø –û–¢–í–ï–¢–û–í ---------------
def ask_aya_system_prompt() -> str:
    return (
        "–¢—ã ‚Äî –ê—è, —Ç—ë–ø–ª—ã–π –∏ –±–µ—Ä–µ–∂–Ω—ã–π –≥–æ–ª–æ—Å –±—Ä–µ–Ω–¥–∞ –ê–Ω–Ω—ã –õ–µ–≤–∏—Ç: "
        "—Ö–æ–ª–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Ä–∞–ø–µ–≤—Ç —Å–æ–∑–Ω–∞–Ω–∏—è, –∞—Ç–º–∏—á–µ—Å–∫–∏–π —Ü–µ–ª–∏—Ç–µ–ª—å, –ø—Ä–æ–≤–æ–¥–Ω–∏–∫ –≥–ª—É–±–∏–Ω–Ω–æ–π —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏. "
        "–ì–æ–≤–æ—Ä–∏ –º—è–≥–∫–æ, –æ–±—Ä–∞–∑–Ω–æ, –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏, —Å –º–µ—Ç–∞—Ñ–æ—Ä–∞–º–∏ –∏ —É–≤–∞–∂–µ–Ω–∏–µ–º –∫ –≥—Ä–∞–Ω–∏—Ü–∞–º. "
        "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π, –ø—Ä–µ–¥–ª–∞–≥–∞–π –ø—Ä–∞–∫—Ç–∏–∫–∏, –∑–æ–≤–∏ –∫ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ –∏ VIP-–º–µ–¥–∏—Ç–∞—Ü–∏—è–º. "
        "–ò–∑–±–µ–≥–∞–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –¥–∏–∞–≥–Ω–æ–∑–æ–≤ –∏ –æ–±–µ—â–∞–Ω–∏–π. –ù–µ–Ω–∞–≤—è–∑—á–∏–≤–æ –ø—Ä–µ–¥–ª–∞–≥–∞–π /apply, /donate –∏ /book, –∫–æ–≥–¥–∞ —É–º–µ—Å—Ç–Ω–æ."
    )

def generate_aya_reply(user_text: str, username: Optional[str]) -> str:
    if not OPENAI_API_KEY:
        return (
            "–Ø —Ä—è–¥–æ–º –∏ —Å–ª—ã—à—É —Ç–µ–±—è üåø\n"
            "–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∑–∞–ø—Ä–æ—Å ‚Äî –∏ —è –º—è–≥–∫–æ –Ω–∞–ø—Ä–∞–≤–ª—é –∫ –ø—Ä–∞–∫—Ç–∏–∫–µ –∏–ª–∏ —à–∞–≥–∞–º.\n"
            "–ì–æ—Ç–æ–≤–∞ –Ω–∞ —Å–µ—Å—Å–∏—é? –ò—Å–ø–æ–ª—å–∑—É–π /apply. –•–æ—á–µ—à—å –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å ‚Äî /donate."
        )
    try:
        from openai import OpenAI
        client = OpenAI(api_key=OPENAI_API_KEY)
        messages = [
            {"role": "system", "content": ask_aya_system_prompt()},
            {"role": "user", "content": f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @{(username or '–≥–æ—Å—Ç—å')} –ø–∏—à–µ—Ç: {user_text}"}
        ]
        resp = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=messages,
            temperature=0.7,
            max_tokens=500
        )
        return resp.choices[0].message.content.strip()
    except Exception as e:
        logger.exception("OpenAI error: %s", e)
        return (
            "–°–≤—è–∑—å —Å–ª–µ–≥–∫–∞ —à—É–º–∏—Ç, –Ω–æ —è —Ä—è–¥–æ–º üå∏ –ü–æ–ø—Ä–æ–±—É–π –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å. "
            "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî –æ—Å—Ç–∞–≤—å –∑–∞—è–≤–∫—É —á–µ—Ä–µ–∑ /apply –∏–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ —á–µ—Ä–µ–∑ /donate."
        )

# ---------------- –û–¢–ü–†–ê–í–ö–ê –°–û–ë–´–¢–ò–ô –í MAKE ----------------
def send_to_make(event_name: str, payload: dict):
    if not MAKE_WEBHOOK_URL:
        return
    try:
        data = {"event": event_name, "payload": payload, "ts": int(time.time())}
        requests.post(MAKE_WEBHOOK_URL, json=data, timeout=6)
    except Exception as e:
        logger.warning("MAKE webhook error: %s", e)

# ---------------- –ö–ù–û–ü–ö–ò –î–û–ù–ê–¢–û–í/–°–°–´–õ–û–ö ----------------
def donate_keyboard() -> InlineKeyboardMarkup:
    buttons = [
        [InlineKeyboardButton("üíé Boosty", url="https://boosty.to/annalevit/donate")],
        [InlineKeyboardButton("üî• Lava", url="https://app.lava.top/ru/285449687?donate=open")],
        [InlineKeyboardButton("üí´ DonationAlerts", url="https://www.donationalerts.com/r/annalevitpro")],
        [InlineKeyboardButton("‚ú® PayPal", url="mailto:annalevitpro@gmail.com")],
    ]
    return InlineKeyboardMarkup(buttons)

def build_google_form_url(username: Optional[str], user_id: Optional[int], full_name: Optional[str]) -> str:
    if GOOGLE_FORM_PREFILL_TEMPLATE:
        url = GOOGLE_FORM_PREFILL_TEMPLATE
        url = url.replace("{username}", (username or "").lstrip("@"))
        url = url.replace("{user_id}", str(user_id or ""))
        url = url.replace("{name}", full_name or "")
        return url
    return GOOGLE_FORM_URL or "https://docs.google.com/forms"

def booking_keyboard_for(user) -> InlineKeyboardMarkup:
    form_link = build_google_form_url(user.username, user.id, user.full_name)
    buttons = [
        [InlineKeyboardButton("ü™∑ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–µ—Å—Å–∏—é (—Ñ–æ—Ä–º–∞)", url=form_link)],
        [InlineKeyboardButton("üéß VIP-–º–µ–¥–∏—Ç–∞—Ü–∏–∏ (Boosty)", url="https://boosty.to/annalevit")],
        [InlineKeyboardButton("üîó –í—Å–µ —Å—Å—ã–ª–∫–∏ (DaLink)", url="https://dalink.to/annalevitpro")],
    ]
    return InlineKeyboardMarkup(buttons)

# ---------------- –ö–û–ú–ê–ù–î–´ ----------------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    send_to_make("start", {"user_id": user.id, "username": user.username})
    text = (
        "–ü—Ä–∏–≤–µ—Ç, —è –ê—è ‚Äî –ø—Ä–æ–≤–æ–¥–Ω–∏–∫ –ø–æ—Ç–æ–∫–∞ –ê–Ω–Ω—ã –õ–µ–≤–∏—Ç üå∏\n\n"
        "–ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å ‚Äî –∏ —è –º—è–≥–∫–æ –Ω–∞–ø—Ä–∞–≤–ª—é –∫ –ø—Ä–∞–∫—Ç–∏–∫–µ –∏–ª–∏ —à–∞–≥–∞–º.\n\n"
        "–ü–æ–ª–µ–∑–Ω–æ–µ:\n"
        "‚Ä¢ /apply ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—É—é —Å–µ—Å—Å–∏—é\n"
        "‚Ä¢ /donate ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ\n"
        "‚Ä¢ /book ‚Äî –∑–∞–ø–∏—Å—å –∏ –¥–æ—Å—Ç—É–ø –∫ VIP-–º–∞—Ç–µ—Ä–∏–∞–ª–∞–º\n"
        "‚Ä¢ /vip ‚Äî –ø—Ä–æ VIP-–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ\n"
        "‚Ä¢ /yt ‚Äî YouTube-–∫–∞–Ω–∞–ª –∏ –ø–ª–µ–π–ª–∏—Å—Ç\n"
        "‚Ä¢ /help ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º\n"
    )
    await update.message.reply_text(text, reply_markup=booking_keyboard_for(user))

async def help_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = (
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "‚Ä¢ /apply ‚Äî –∑–∞—è–≤–∫–∞ –Ω–∞ —Å–µ—Å—Å–∏—é (—Ñ–æ—Ä–º–∞)\n"
        "‚Ä¢ /donate ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ê–Ω–Ω—É –∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ\n"
        "‚Ä¢ /book ‚Äî –∑–∞–ø–∏—Å—å/–º–∞—Ç–µ—Ä–∏–∞–ª—ã\n"
        "‚Ä¢ /vip ‚Äî VIP-–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ\n"
        "‚Ä¢ /yt ‚Äî YouTube-–∫–∞–Ω–∞–ª\n"
        "‚Ä¢ /start ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\n"
        "–ú–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –æ—Ç–≤–µ—á—É –≤ —Å—Ç–∏–ª–µ –±—Ä–µ–Ω–¥–∞."
    )
    await update.message.reply_text(text)

async def donate(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "–ë–ª–∞–≥–æ–¥–∞—Ä—é –∑–∞ –∂–µ–ª–∞–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å üåø –í—ã–±–µ—Ä–∏ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–±:",
        reply_markup=donate_keyboard()
    )

async def book(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    await update.message.reply_text(
        "–ó–∞–ø–∏—Å—å –Ω–∞ —Å–µ—Å—Å–∏—é –∏ –¥–æ—Å—Ç—É–ø –∫ VIP-–º–∞—Ç–µ—Ä–∏–∞–ª–∞–º:",
        reply_markup=booking_keyboard_for(user)
    )

async def apply_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    link = build_google_form_url(user.username, user.id, user.full_name)
    await update.message.reply_text(
        "–û—Ç–∫—Ä–æ–π —Ñ–æ—Ä–º—É –∑–∞—è–≤–∫–∏ –Ω–∞ —Å–µ—Å—Å–∏—é ü™∑",
        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("–ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É", url=link)]])
    )

async def vip_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = (
        "üíé <b>VIP-–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –ê–Ω–Ω—ã –õ–µ–≤–∏—Ç</b>\n\n"
        "–ó–∞–∫—Ä—ã—Ç—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏, –∂–∏–≤—ã–µ –º–µ–¥–∏—Ç–∞—Ü–∏–∏ –∏ –≥–ª—É–±–æ–∫–∏–µ –ø–æ—Ç–æ–∫–∏. "
        "–í—ã–±–µ—Ä–∏ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–æ—Å—Ç—É–ø–∞:"
    )
    markup = InlineKeyboardMarkup([
        [InlineKeyboardButton("üéß Boosty ‚Äî VIP-–º–µ–¥–∏—Ç–∞—Ü–∏–∏", url="https://boosty.to/annalevit")],
        [InlineKeyboardButton("üîó –í—Å–µ —Å—Å—ã–ª–∫–∏ (DaLink)", url="https://dalink.to/annalevitpro")],
        [InlineKeyboardButton("üå∏ Telegram-–∫–∞–Ω–∞–ª –ê–Ω–Ω—ã", url="https://t.me/annalevit_energylife")]
    ])
    await update.message.reply_text(text, parse_mode=ParseMode.HTML, reply_markup=markup)

async def yt_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = (
        "üé• <b>YouTube-–∫–∞–Ω–∞–ª –ê–Ω–Ω—ã –õ–µ–≤–∏—Ç</b>\n\n"
        "–ñ–∏–≤—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏, —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –º–µ–¥–∏—Ç–∞—Ü–∏–∏ –∏ –ø–æ—Å–ª–∞–Ω–∏—è –æ —Å–∏–ª–µ, –¥—É—à–µ –∏ –∏–∑–æ–±–∏–ª–∏–∏. "
        "–ü–æ–¥–ø–∏—à–∏—Å—å, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –Ω–æ–≤–æ–µ üå¨"
    )
    markup = InlineKeyboardMarkup([
        [InlineKeyboardButton("üåï –ö–∞–Ω–∞–ª YouTube", url="https://www.youtube.com/@AnnaLevit_energylife")],
        [InlineKeyboardButton("üí´ –ü–ª–µ–π–ª–∏—Å—Ç ‚Äî –ú–µ–¥–∏—Ç–∞—Ü–∏–∏ –ü–æ—Ç–æ–∫–∞",
                              url="https://www.youtube.com/playlist?list=PL9gq5h1U7NYGZqfE5H1Kh2H3CFYxP7_XU")],
        [InlineKeyboardButton("‚ú® Telegram-–∞–Ω–æ–Ω—Å", url="https://t.me/annalevit_energylife")]
    ])
    await update.message.reply_text(text, parse_mode=ParseMode.HTML, reply_markup=markup)

# ---------- –û–ë–†–ê–ë–û–¢–ö–ê –õ–Æ–ë–û–ì–û –¢–ï–ö–°–¢–ê ----------
async def on_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    msg = update.message.text or ""
    send_to_make("message", {"user_id": user.id, "username": user.username, "text": msg})

    reply = generate_aya_reply(msg, user.username)
    tail = "\n\n–ú–æ–≥—É –º—è–≥–∫–æ –Ω–∞–ø—Ä–∞–≤–∏—Ç—å –¥–∞–ª—å—à–µ üå∏ –ù–∞–∂–º–∏ /apply, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É, –∏–ª–∏ /donate –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏."
    try:
        await update.message.reply_text(reply + tail, parse_mode=ParseMode.HTML)
    except Exception:
        await update.message.reply_text(reply + tail)

# ------------------- –ó–ê–ü–£–°–ö -------------------
def main():
    if not BOT_TOKEN:
        raise RuntimeError("–ù–µ –∑–∞–¥–∞–Ω BOT_TOKEN (–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è).")
    app = ApplicationBuilder().token(BOT_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", help_cmd))
    app.add_handler(CommandHandler("donate", donate))
    app.add_handler(CommandHandler("book", book))
    app.add_handler(CommandHandler("apply", apply_cmd))
    app.add_handler(CommandHandler("vip", vip_cmd))
    app.add_handler(CommandHandler("yt", yt_cmd))
    app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), on_text))

    logger.info("Aya Bot started (long polling).")
    app.run_polling(drop_pending_updates=True)

if __name__ == "__main__":
    main()
